<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Formulário com Campos DateTime</title>
  <script src="index.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/themes/prism-okaidia.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/prism.min.js"></script>
</head>

<body>
  <script>
    Prism.highlightAll();
  </script>

  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: Arial, Helvetica, sans-serif;
    }

    /* Style the header */
    header {
      background-color: #666;
      padding: 30px;
      text-align: center;
      font-size: 35px;
      color: white;
    }

    /* Create two columns/boxes that floats next to each other */
    nav {
      float: left;
      width: 30%;
      height: 300px;
      /* only for demonstration, should be removed */
      background: #ccc;
      padding: 20px;
    }

    /* Style the list inside the menu */
    nav ul {
      list-style-type: none;
      padding: 0;
    }

    article {
      float: left;
      padding: 20px;
      width: 70%;
      background-color: #f1f1f1;
      height: 300px;
      /* only for demonstration, should be removed */
    }

    /* Clear floats after the columns */
    section::after {
      content: "";
      display: table;
      clear: both;
    }

    /* Style the footer */
    footer {
      background-color: #777;
      padding: 10px;
      text-align: center;
      color: white;
    }

    /* Responsive layout - makes the two columns/boxes stack on top of each other instead of next to each other, on small screens */
    @media (max-width: 600px) {

      nav,
      article {
        width: 100%;
        height: auto;
      }
    }


    body {
      background-color: rgb(228, 227, 227);
    }

    div {
      display: block;
    }

    table,
    th,
    td {
      border: 1px solid black;
      border-radius: 10px;
    }

    #tabela {
      width: 70%;
    }

    .centro {
      text-align: center;
      border-collapse: collapse;
    }
  </style>
  <h2>Avaliação II</h2>
  <p>Desenvolver um algoritmo que seja capaz de receber dois parâmetros com data e hora e, a partir destes, calcular as
    horas úteis entre as datas. Como apoio, deve ser adotado uma tabela de expediente, contendo os campos abaixo.

    Dia da semana, Flag de dia útil ou não, Hora de início do turno, Hora de inicio do almoço, Hora de término do almoço
    e Hora de término do expediente.

    Sábado e domingo devem ser considerados dias não úteis.</p>

  <header>
    <h2>Calculo de Horas úteis</h2>
  </header>

  <section>
    <nav>
      <form class="centro" id="meuForm">
        <div class="row">
          <label for="data_inicial">Data Inicial:</label>
          <input type="datetime-local" id="data_inicial" name="data_inicial" required><br><br>

          <label for="data_final">Data Final:</label>
          <input type="datetime-local" id="data_final" name="data_final" required><br><br>

          <input type="submit" value="Calcular">
        </div>
      </form>
      <h1 class="centro" id="resultado"></h1>
    </nav>

    <article>
      <table class="centro" id="tabela">
        <thead style="border-collapse: collapse; text-align: center;">
          <h2>Dias Úteis</h2>
        </thead>
        <thead>
          <tr>
            <th>Dia</th>
            <th>Hora Inicial</th>
            <th>Hora Almoço</th>
            <th>Retorno Almoço</th>
            <th>Hora Saída</th>
            <th>Util</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Seguna</td>
            <td contenteditable="true">08:00:00</td>
            <td contenteditable="true">12:00:00</td>
            <td contenteditable="true">13:00:00</td>
            <td contenteditable="true">17:00:00</td>
            <td contenteditable="true"><input type="checkbox"></td>
          </tr>
          <tr>
            <td contenteditable="true">Terça</td>
            <td contenteditable="true">08:00:00</td>
            <td contenteditable="true">12:00:00</td>
            <td contenteditable="true">13:00:00</td>
            <td contenteditable="true">17:00:00</td>
            <td contenteditable="true"><input type="checkbox"></td>
          </tr>
          <tr>
            <td contenteditable="true">Quarta</td>
            <td contenteditable="true">08:00:00</td>
            <td contenteditable="true">12:00:00</td>
            <td contenteditable="true">13:00:00</td>
            <td contenteditable="true">17:00:00</td>
            <td contenteditable="true"><input type="checkbox"></td>
          </tr>
          <tr>
            <td contenteditable="true">Quinta</td>
            <td contenteditable="true">08:00:00</td>
            <td contenteditable="true">12:00:00</td>
            <td contenteditable="true">13:00:00</td>
            <td contenteditable="true">17:00:00</td>
            <td contenteditable="true"><input type="checkbox"></td>
          </tr>
          <tr>
            <td contenteditable="true">Sexta</td>
            <td contenteditable="true">08:00:00</td>
            <td contenteditable="true">12:00:00</td>
            <td contenteditable="true">13:00:00</td>
            <td contenteditable="true">17:00:00</td>
            <td contenteditable="true"><input type="checkbox"></td>
          </tr>
        </tbody>

      </table>
    </article>
  </section>
  <button onclick="mostrarCodigo()">Mostrar codigo</button>
  <footer id="footer" hidden="true">
    <h1>Código em linguagem python com os endpoints</h1>
    <pre class="language-python">
      <code>
        from flask import Flask, jsonify, request, render_template
        from datetime import datetime
        from func import calcular_horas
        
        app = Flask(__name__)
        
        @app.route('/')
        def index():
            return render_template('index.html')
        
        @app.route('/api', methods=['GET'])
        def api():
            return jsonify({'message': 'Olá, mundo! Esta é uma API básica em Python.'})
        
        @app.route('/api', methods=['POST'])
        def recebe_json():
            try:
                # Obter os dados do corpo da requisição em formato JSON
                data = request.get_json()
        
                # Extrair as datas
                data_inicial = data['dataInicial']
                data1 = datetime.strptime(data_inicial, '%Y-%m-%d %H:%M:%S')
                data_final = data['dataFinal']
                data2 = datetime.strptime(data_final, '%Y-%m-%d %H:%M:%S')
                resultado = calcular_horas(data1, data2, data.get('dados'))
        
                # Retorna o resultado
                return jsonify({'horas': str(resultado)}), 200
        
                #return jsonify({'message': 'JSON recebido com sucesso'}), 200
        
            except Exception as e:
                return jsonify({'error': str(e)}), 400
        
        
        
        if __name__ == '__main__':
            app.run(debug=True)
      </code>

    </pre><br><br>
    <h1>Código em linguagem python com a funcao de calculo</h1>
    <pre class="language-python">

      <code>
        from datetime import datetime, timedelta

        def calcular_horas(data_inicial, data_final, dados = None):
            # Inicializa a variável horas como um objeto timedelta, que representa a diferença entre duas datas ou horas
            horas = timedelta()
        
            # Atribui o valor de data_inicial à variável data_atual
            data_atual = data_inicial
        
            if dados == None:
                # Define uma lista de dicionários com informações sobre os dias da semana e horários associados
                dados = [
                    {'dia': 0, 'hora_inicial': '08:00:00', 'hora_almoco': '12:00:00', 'retorno_almoco': '13:00:00', 'hora_saida': '17:00:00', 'util': True},
                    {'dia': 1, 'hora_inicial': '08:00:00', 'hora_almoco': '12:00:00', 'retorno_almoco': '13:00:00', 'hora_saida': '17:00:00', 'util': True},
                    {'dia': 2, 'hora_inicial': '08:00:00', 'hora_almoco': '12:00:00', 'retorno_almoco': '13:00:00', 'hora_saida': '17:00:00', 'util': True},
                    {'dia': 3, 'hora_inicial': '08:00:00', 'hora_almoco': '12:00:00', 'retorno_almoco': '13:00:00', 'hora_saida': '17:00:00', 'util': True},
                    {'dia': 4, 'hora_inicial': '08:00:00', 'hora_almoco': '12:00:00', 'retorno_almoco': '13:00:00', 'hora_saida': '17:00:00', 'util': True},
                    {'dia': 5, 'hora_inicial': '08:00:00', 'hora_almoco': '12:00:00', 'retorno_almoco': '13:00:00', 'hora_saida': '17:00:00', 'util': False},
                    {'dia': 6, 'hora_inicial': '08:00:00', 'hora_almoco': '12:00:00', 'retorno_almoco': '13:00:00', 'hora_saida': '17:00:00', 'util': False},
                ]
        
            # Verifica se a data inicial é menor que a data final
            if data_inicial < data_final:
        
                # Enquanto a data atual for menor ou igual à data final
                while data_atual.date() <= data_final.date():
                    # Procura na lista dados por um dicionário correspondente ao dia da semana da data_atual e que seja considerado útil
                    dia = next((x for x in dados if x['dia'] == data_atual.weekday() and x['util']), None)
        
                    # Verifica se foi encontrado um dicionário correspondente ao dia da semana
                    if dia is not None:
                        # Converte os horários de string para objetos datetime
                        h_inicial = datetime.strptime(dia['hora_inicial'], '%H:%M:%S')
                        h_almoco = datetime.strptime(dia['hora_almoco'], '%H:%M:%S')
                        h_retorno = datetime.strptime(dia['retorno_almoco'], '%H:%M:%S')
                        h_fim = datetime.strptime(dia['hora_saida'], '%H:%M:%S')
        
                        # Ajusta os horários de acordo com a data atual
                        h_inicial = max(data_inicial, datetime.combine(data_atual.date(), h_inicial.time()))
                        h_almoco = min(data_final, datetime.combine(data_atual.date(), h_almoco.time()))
                        h_retorno = max(data_inicial, datetime.combine(data_atual.date(), h_retorno.time()))
                        h_fim = min(data_final, datetime.combine(data_atual.date(), h_fim.time()))
        
                        # Calcula e acumula as horas trabalhadas
                        horas += h_almoco - h_inicial if h_almoco > h_inicial else timedelta()
                        horas += h_fim - h_retorno if h_fim > h_retorno else timedelta()
        
                    # Avança para o próximo dia
                    data_atual += timedelta(days=1)
            else:
                # Se a data inicial não for menor que a data final, levanta uma exceção
                raise Exception("Data inicial deve ser menor que a data final")
        
            # Converte os segundos totais em horas e minutos
            horas_totais = horas.total_seconds() // 3600
            minutos_totais = (horas.total_seconds() % 3600) // 60
        
            # Retorna uma string formatada com o total de horas e minutos
            return f'{int(horas_totais)} horas e {int(minutos_totais)} minutos'
      </code>
  </pre>
  </footer>
  <script>
    let horasValidas = true;
    document.getElementById("tabela").addEventListener("input", function (event) {
      const target = event.target;

      if (target.tagName === "TD") {
        const hora = target.innerText;

        const formatoValido = /^([01]?[0-9]|2[0-3]):[0-5][0-9]:[0-5][0-9]$/.test(hora);

        if (!formatoValido) {
          horasValidas = false;
        } else {
          horasValidas = true;
        }
      }
    });

    document.getElementById('meuForm').addEventListener('submit', function (event) {
      event.preventDefault();
      if (!horasValidas) return alert('Todos os horarios devem estar no formato (HH:MM:SS)');
      let dados = extrairDadosDaTabela();

      var dataInicial = moment(document.getElementById('data_inicial').value).format('YYYY-MM-DD HH:mm:ss');
      var dataFinal = moment(document.getElementById('data_final').value).format('YYYY-MM-DD HH:mm:ss');

      fetch('/api', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ dataInicial, dataFinal, dados }),

      })
        .then(response => response.json())
        .then(data => {
          if (data.horas != undefined) {
            let resultado = document.getElementById('resultado');
            resultado.innerHTML = data.horas;
          } else {
            throw ('', data.error);
          }
        })
        .catch((error) => {
          console.error('Erro:', error);
          let resultado = document.getElementById('resultado');
          resultado.innerHTML = '';
          alert('Erro:' + error);
        });
    });

    function mostrarCodigo() {
      let fot = document.getElementById("footer");
      fot.hidden = !fot.hidden;
    }

    function extrairDadosDaTabela() {
      const tabela = document.getElementById('tabela');
      const linhas = tabela.querySelectorAll('tbody tr');

      const dias_da_semana = [];

      linhas.forEach((linha, index) => {
        const colunas = linha.querySelectorAll('td');

        const dia = index;
        const hora_inicial = colunas[1].textContent;
        const hora_almoco = colunas[2].textContent;
        const retorno_almoco = colunas[3].textContent;
        const hora_saida = colunas[4].textContent;
        const util = colunas[5].querySelector('input').checked;

        const dados = {
          'dia': dia,
          'hora_inicial': hora_inicial,
          'hora_almoco': hora_almoco,
          'retorno_almoco': retorno_almoco,
          'hora_saida': hora_saida,
          'util': util
        };

        dias_da_semana.push(dados);
      });

      return dias_da_semana;
    }

  </script>
</body>

</html>