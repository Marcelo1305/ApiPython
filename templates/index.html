<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Formulário com Campos DateTime</title>
  <script src="index.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/themes/prism-okaidia.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/prism.min.js"></script>
</head>

<body>
  <script>
    Prism.highlightAll();
  </script>

  <style>
    * {
      box-sizing: border-box;
    }
    .verde{
      color: rgb(45, 99, 50);
    }

    body {
      font-family: Arial, Helvetica, sans-serif;
    }

    /* Style the header */
    header {
      background-color: #666;
      padding: 30px;
      text-align: center;
      font-size: 35px;
      color: white;
    }

    /* Create two columns/boxes that floats next to each other */
    nav {
      float: left;
      width: 30%;
      height: 300px;
      /* only for demonstration, should be removed */
      background: #ccc;
      padding: 20px;
    }

    /* Style the list inside the menu */
    nav ul {
      list-style-type: none;
      padding: 0;
    }

    article {
      float: left;
      padding: 20px;
      width: 70%;
      background-color: #f1f1f1;
      height: 300px;
      /* only for demonstration, should be removed */
    }

    /* Clear floats after the columns */
    section::after {
      content: "";
      display: table;
      clear: both;
    }

    /* Style the footer */
    footer {
      background-color: #777;
      padding: 10px;
      /* text-align: center; */
      color: white;
    }

    .apresentacao {
      font-family: Arial, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
    }

    /* Responsive layout - makes the two columns/boxes stack on top of each other instead of next to each other, on small screens */
    @media (max-width: 600px) {

      nav,
      article {
        width: 100%;
        height: auto;
      }
    }

    code {
      color: aliceblue;
    }

    pre {
      background-color: #272626;
      padding: 10px;
      overflow-x: auto;
      border-radius: 5px;
      margin-bottom: 20px;
    }

    h2 {
      color: #333;
    }

    p {
      line-height: 1.5;
    }

    body {
      background-color: rgb(228, 227, 227);
    }

    div {
      display: block;
    }

    table,
    th,
    td {
      border: 1px solid black;
      border-radius: 10px;
    }

    #tabela {
      width: 70%;
    }

    .centro {
      text-align: center;
      border-collapse: collapse;
    }
  </style>
  <h2>Avaliação II</h2>
  <p>Desenvolver um algoritmo que seja capaz de receber dois parâmetros com data e hora e, a partir destes, calcular as
    horas úteis entre as datas. Como apoio, deve ser adotado uma tabela de expediente, contendo os campos abaixo.

    Dia da semana, Flag de dia útil ou não, Hora de início do turno, Hora de inicio do almoço, Hora de término do almoço
    e Hora de término do expediente.

    Sábado e domingo devem ser considerados dias não úteis.</p>

  <header>
    <h2>Calculo de Horas úteis</h2>
  </header>

  <section>
    <nav>
      <form class="centro" id="meuForm">
        <div class="row">
          <label for="data_inicial">Data Inicial:</label>
          <input type="datetime-local" id="data_inicial" name="data_inicial" required><br><br>

          <label for="data_final">Data Final:</label>
          <input type="datetime-local" id="data_final" name="data_final" required><br><br>

          <input type="submit" value="Calcular">
        </div>
      </form>
      <h1 class="centro" id="resultado"></h1>
    </nav>

    <article>
      <table class="centro" id="tabela">
        <thead style="border-collapse: collapse; text-align: center;">
          <h2>Dias Úteis</h2>
        </thead>
        <thead>
          <tr>
            <th>Dia</th>
            <th>Hora Inicial</th>
            <th>Hora Almoço</th>
            <th>Retorno Almoço</th>
            <th>Hora Saída</th>
            <th>Util</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Seguna</td>
            <td contenteditable="true">08:00:00</td>
            <td contenteditable="true">12:00:00</td>
            <td contenteditable="true">13:00:00</td>
            <td contenteditable="true">17:00:00</td>
            <td contenteditable="true"><input type="checkbox"></td>
          </tr>
          <tr>
            <td contenteditable="true">Terça</td>
            <td contenteditable="true">08:00:00</td>
            <td contenteditable="true">12:00:00</td>
            <td contenteditable="true">13:00:00</td>
            <td contenteditable="true">17:00:00</td>
            <td contenteditable="true"><input type="checkbox"></td>
          </tr>
          <tr>
            <td contenteditable="true">Quarta</td>
            <td contenteditable="true">08:00:00</td>
            <td contenteditable="true">12:00:00</td>
            <td contenteditable="true">13:00:00</td>
            <td contenteditable="true">17:00:00</td>
            <td contenteditable="true"><input type="checkbox"></td>
          </tr>
          <tr>
            <td contenteditable="true">Quinta</td>
            <td contenteditable="true">08:00:00</td>
            <td contenteditable="true">12:00:00</td>
            <td contenteditable="true">13:00:00</td>
            <td contenteditable="true">17:00:00</td>
            <td contenteditable="true"><input type="checkbox"></td>
          </tr>
          <tr>
            <td contenteditable="true">Sexta</td>
            <td contenteditable="true">08:00:00</td>
            <td contenteditable="true">12:00:00</td>
            <td contenteditable="true">13:00:00</td>
            <td contenteditable="true">17:00:00</td>
            <td contenteditable="true"><input type="checkbox"></td>
          </tr>
        </tbody>

      </table>
    </article>
  </section>
  <button onclick="mostrarCodigo()" hidden="true">Mostrar codigo</button>
  <footer id="footer">
    <div class="apresentacao">
      <h1>Documentação do Código Python</h1>
      <h2>Função: calcular_horas</h2>
      <p>
        Esta função Python calcula a carga horária útil entre duas datas, considerando um conjunto padrão de horários de
        trabalho em dias úteis.
      </p>
      <pre>
        <code>
      from datetime import datetime, timedelta
        
      def calcular_horas(data_inicial, data_final, dados = None):
        <span class="verde"># Inicializa a variável horas como um objeto timedelta, que representa a diferença entre duas datas ou horas</span>
        horas = timedelta()
  
        <span class="verde"># Atribui o valor de data_inicial à variável data_atual</span>
        data_atual = data_inicial
  
        if dados == None:
            <span class="verde"># Define uma lista de dicionários com informações sobre os dias da semana e horários associados</span>
            dados = [
                {'dia': 0, 'hora_inicial': '08:00:00', 'hora_almoco': '12:00:00', 'retorno_almoco': '13:00:00', 'hora_saida': '17:00:00', 'util': True},
                {'dia': 1, 'hora_inicial': '08:00:00', 'hora_almoco': '12:00:00', 'retorno_almoco': '13:00:00', 'hora_saida': '17:00:00', 'util': True},
                {'dia': 2, 'hora_inicial': '08:00:00', 'hora_almoco': '12:00:00', 'retorno_almoco': '13:00:00', 'hora_saida': '17:00:00', 'util': True},
                {'dia': 3, 'hora_inicial': '08:00:00', 'hora_almoco': '12:00:00', 'retorno_almoco': '13:00:00', 'hora_saida': '17:00:00', 'util': True},
                {'dia': 4, 'hora_inicial': '08:00:00', 'hora_almoco': '12:00:00', 'retorno_almoco': '13:00:00', 'hora_saida': '17:00:00', 'util': True},
                {'dia': 5, 'hora_inicial': '08:00:00', 'hora_almoco': '12:00:00', 'retorno_almoco': '13:00:00', 'hora_saida': '17:00:00', 'util': False},
                {'dia': 6, 'hora_inicial': '08:00:00', 'hora_almoco': '12:00:00', 'retorno_almoco': '13:00:00', 'hora_saida': '17:00:00', 'util': False},
            ]
  
        <span class="verde"># Verifica se a data inicial é menor que a data final</span>
        if data_inicial < data_final:
  
            <span class="verde"># Enquanto a data atual for menor ou igual à data final</span>
            while data_atual.date() <= data_final.date():
                <span class="verde"># Procura na lista dados por um dicionário correspondente ao dia da semana da data_atual e que seja considerado útil</span>
                dia = next((x for x in dados if x['dia'] == data_atual.weekday() and x['util']), None)
  
                <span class="verde"># Verifica se foi encontrado um dicionário correspondente ao dia da semana</span>
                if dia is not None:
                    <span class="verde"># Converte os horários de string para objetos datetime</span>
                    h_inicial = datetime.strptime(dia['hora_inicial'], '%H:%M:%S')
                    h_almoco = datetime.strptime(dia['hora_almoco'], '%H:%M:%S')
                    h_retorno = datetime.strptime(dia['retorno_almoco'], '%H:%M:%S')
                    h_fim = datetime.strptime(dia['hora_saida'], '%H:%M:%S')
  
                    <span class="verde"># Ajusta os horários de acordo com a data atual</span>
                    h_inicial = max(data_inicial, datetime.combine(data_atual.date(), h_inicial.time()))
                    h_almoco = min(data_final, datetime.combine(data_atual.date(), h_almoco.time()))
                    h_retorno = max(data_inicial, datetime.combine(data_atual.date(), h_retorno.time()))
                    h_fim = min(data_final, datetime.combine(data_atual.date(), h_fim.time()))
  
                    <span class="verde"># Calcula e acumula as horas trabalhadas</span>
                    horas += h_almoco - h_inicial if h_almoco > h_inicial else timedelta()
                    horas += h_fim - h_retorno if h_fim > h_retorno else timedelta()
  
                <span class="verde"># Avança para o próximo dia</span>
                data_atual += timedelta(days=1)
        else:
            <span class="verde"># Se a data inicial não for menor que a data final, levanta uma exceção</span>
            raise Exception("Data inicial deve ser menor que a data final")
  
        <span class="verde"># Converte os segundos totais em horas e minutos</span>
        horas_totais = horas.total_seconds() // 3600
        minutos_totais = (horas.total_seconds() % 3600) // 60
  
        <span class="verde"># Retorna uma string formatada com o total de horas e minutos</span>
        return f'{int(horas_totais)} horas e {int(minutos_totais)} minutos'
        </code>
      </pre>
      <h3>Descrição da função:</h3>
      <p>
        
      </p>
    </div>
  </footer>
  <script>
    let horasValidas = true;
    document.getElementById("tabela").addEventListener("input", function (event) {
      const target = event.target;

      if (target.tagName === "TD") {
        const hora = target.innerText;

        const formatoValido = /^([01]?[0-9]|2[0-3]):[0-5][0-9]:[0-5][0-9]$/.test(hora);

        if (!formatoValido) {
          horasValidas = false;
        } else {
          horasValidas = true;
        }
      }
    });

    document.getElementById('meuForm').addEventListener('submit', function (event) {
      event.preventDefault();
      if (!horasValidas) return alert('Todos os horarios devem estar no formato (HH:MM:SS)');
      let dados = extrairDadosDaTabela();

      var dataInicial = moment(document.getElementById('data_inicial').value).format('YYYY-MM-DD HH:mm:ss');
      var dataFinal = moment(document.getElementById('data_final').value).format('YYYY-MM-DD HH:mm:ss');

      fetch('/api', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ dataInicial, dataFinal, dados }),

      })
        .then(response => response.json())
        .then(data => {
          if (data.horas != undefined) {
            let resultado = document.getElementById('resultado');
            resultado.innerHTML = data.horas;
          } else {
            throw ('', data.error);
          }
        })
        .catch((error) => {
          console.error('Erro:', error);
          let resultado = document.getElementById('resultado');
          resultado.innerHTML = '';
          alert('Erro:' + error);
        });
    });

    function mostrarCodigo() {
      let fot = document.getElementById("footer");
      fot.hidden = !fot.hidden;
    }

    function extrairDadosDaTabela() {
      const tabela = document.getElementById('tabela');
      const linhas = tabela.querySelectorAll('tbody tr');

      const dias_da_semana = [];

      linhas.forEach((linha, index) => {
        const colunas = linha.querySelectorAll('td');

        const dia = index;
        const hora_inicial = colunas[1].textContent;
        const hora_almoco = colunas[2].textContent;
        const retorno_almoco = colunas[3].textContent;
        const hora_saida = colunas[4].textContent;
        const util = colunas[5].querySelector('input').checked;

        const dados = {
          'dia': dia,
          'hora_inicial': hora_inicial,
          'hora_almoco': hora_almoco,
          'retorno_almoco': retorno_almoco,
          'hora_saida': hora_saida,
          'util': util
        };

        dias_da_semana.push(dados);
      });

      return dias_da_semana;
    }
  </script>
</body>

</html>